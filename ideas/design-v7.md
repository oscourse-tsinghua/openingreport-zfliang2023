# 在多 CPU、多地址空间、用户态中使用的中断控制器设计方案

需要解决的核心问题：

- [x] 控制器内部的空间容量问题
- [ ] 多地址空间的隔离问题

## 数据结构

### 单个地址空间内的数据结构

- 就绪队列
- 中断向量表

### 快速唤醒表项(FWE: Fast Wake-Up Entry)

```
+-----------+---------+----------+------------+
| Rqtp (63) | Mea (1) | Ivt (63) | Enable (1) |
+-----------+---------+----------+------------+
```

- Rqtp: (Ready queue's tail pointer) 就绪队列的尾指针，2 字节对齐，只记录 63 位
- Mea: (Mutually exclusive access) 表示 CPU 是否正在访问就绪队列，当 CPU 正在访问就绪队列时，控制器将等待 CPU 操作完成
- Ivt: (Interrupt vector table) 进程内部的中断向量表，2 字节对齐，只记录 63位
- Enable: 快速唤醒机制是否使能

### 全局快速唤醒表(GFWT: Global Fast Wake-Up Table)

由每个进程的快速唤醒机制信息表项组成，进程 ID 为对应的下标。

|Pid     |FWE   |
|--------|------|
|pid0    |fwe0  |
|......  |      |
|pidN    |fweN  |

### 控制器缓存

控制器内部的缓存为全局快速唤醒表的子集。

## 快速唤醒机制的行为

控制器内部使用 data move 部件，从中断向量表中拿到对应的中断处理任务指针，将其添加到就绪队列的尾部，并更新尾指针。具体的行为如下：

## 如何激发快速唤醒机制

- [ ] 激发对象
- [ ] 快速唤醒机制的目标地址空间、目标中断处理任务
- [ ] 权限检查

### 激发对象

- 设备
- 软件

### 目标地址空间、目标中断处理任务

- 当设备产生了外部中断之后，这个设备是哪个进程在使用？不同的设备可能是不同的进程在使用。
   ==控制器内部维护中断向量号与 Pid 之间的映射表。==
- 软件发起中断
  ==通过向指定端口写目标进程的 pid 和对应的中断向量号，来发起针对目标进程的快速唤醒机制。==

### 权限检查

- 外设的快速唤醒机制权限检查：
  ==当进程需要申请独占某个设备时，通过系统调用进行申请，由内核检查设备是否被其他进程占用，若已被其他进程占用，则返回失败；若无，则允许进程独占设备，并更新控制器中的中断向量号与 Pid 映射表。==
- 进程之间的快速唤醒机制权限检查：
  ==1. 通过系统调用注册发送方、接收方，由内核在内存中维护发送方————接收方关系表
  2. 通过系统调用获取接收方的 Pid、软件中断向量号
  3. 发送方通过向指定端口写Pid和中断向量号，发起软件中断，控制器执行接收方的快速唤醒操作==


## 地址空间隔离

隔离主要体现在不能随意使能某个进程某个中断的快速唤醒机制。

1. 对于就绪队列与中断向量表的访问，由进程各自进行维护，通过已有的虚拟内存机制进行隔离
2. 控制器执行某个进程、中断的快速唤醒机制，对于外设、软件发起方，在获取到目标对象的 Pid 和 irq 之前，一定是通过系统调用拿去到这些基本信息。（系统调用的操作也理解为软件中断，但其是默认使能的，目标进程一定是内核、对应的向量号即为系统调用编号）

<!-- ## 与目前的区别

目前调度器的接口

|接口|描述|
|----|----|
|add |把创建的任务添加到控制器中|
|register_irq|注册阻塞协程并使能快速唤醒机制|
|fetch|从控制器中取出最高优先级的协程|
|soft_irq|写指定接口，发起软中断|

需要保留的接口

1. soft_irq：发起软中断，也需要增加权限判断机制（系统调用、IPC，两种用途的区别在于目标对象不同）

需要增加的接口

1. init_proc：初始化进程，将进程的就绪队列和阻塞队列的指针记录到控制器中（在内存和控制器中均存在记录，初始化的进程，大概率为近期会使用的，因此直接在控制器中增加记录），直接设置成进程池，在系统初始化的时候与分配好使用的空间

其余的接口完全由软件实现：

1. add：
2. fetch：
3. register_irq：

控制器内部的行为：

1. 针对元信息的缓存机制行为
2. 发起软中断需要增加检查机制
3. 数据搬运的工作

内存中的数据结构必须严格按照控制器中的访问格式进行设计，才能保证数据搬运的工作。 -->
